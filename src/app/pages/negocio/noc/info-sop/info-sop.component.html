<!-- Overlay local del componente -->
@if (isReady) {
<div class="fade-in">
  <!-- ======= TU CONTENIDO ORIGINAL (SIN CAMBIOS) ======= -->
  <section class="container mt-1">
    <div class="d-flex justify-content-between border-5 m-2">
      <!-- TABLA DATOS DEL USUARIO -->
      <table class="table table-bordered table-striped w-50 me-3">
        <thead class="custom-header">
          <tr>
            <th colspan="2" class="text-center">Datos del Usuario</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Cliente</th>

            <td>{{ servicioSeleccionado?.nombre_completo }}</td>
          </tr>
          <tr>
            <th scope="row">CÃ©dula</th>
            <td>{{ servicioSeleccionado?.cedula }}</td>
          </tr>
          <tr>
            <th scope="row">Precio</th>
            <td>${{ servicioSeleccionado?.servicios[0]?.precio }}</td>
          </tr>
          <tr>
            <th scope="row">Estado de Pago</th>
            <td>{{ servicioSeleccionado?.servicios[0]?.estado }}</td>
          </tr>
          <tr>
            <th scope="row">Plan</th>
            <td>{{ servicioSeleccionado?.servicios[0]?.plan_nombre }}</td>
          </tr>
          <tr>
            <th scope="row">Cortado</th>
            <td>{{ servicioSeleccionado?.servicios[0]?.cortado }}</td>
          </tr>
        </tbody>
      </table>
      <!-- TABLA DATOS DEL SOPORTE -->
      <table class="table table-bordered table-striped w-50">
        <thead class="custom-header">
          <tr>
            <th colspan="2" class="text-center">Datos del Soporte</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Motivo</th>
            <td>
              <span>
                @switch (soporte?.reg_sop_opc) { @case (1) {
                <span>Sin servicio de Internet</span>
                } @case (2) {
                <span> Internet Intermitente</span>
                } @case (3) {
                <span> Cambio de contraseÃ±a</span>
                } @case (4) {
                <span> Manipulacion de equipos</span>
                } @case (5) {
                <span> Sin Definir</span>
                } }
              </span>
            </td>
          </tr>
          <tr>
            <th scope="row">Ingreso de Soporte</th>
            <td>
              {{ soporte?.reg_sop_fecha | date : "EEEE dd MMMM YYYY hh:mm:ss" }}
            </td>
          </tr>
          <tr>
            <th scope="row">Inicio RevisiÃ³n</th>
            <td>
              {{
                soporte?.reg_sop_fecha_acepta
                  | date : "EEEE dd MMMM YYYY hh:mm:ss"
              }}
            </td>
          </tr>
          <tr>
            <th scope="row">TelÃ©fonos Soporte</th>
            <td>{{ soporte?.reg_sop_tel }}</td>
          </tr>
          <tr>
            <th scope="row">Registrado por</th>
            <td>{{ soporte?.reg_sop_registrado_por_nombre }}</td>
          </tr>
          <tr>
            <th scope="row">ObservaciÃ³n</th>
            <td>{{ soporte?.reg_sop_coment_cliente }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- DIV TABLA DEL SERVICIO Y SECCION SOLUCION  -->
    <div class="d-flex justify-content-between align-items-stretch">
      <!-- TABLA DATOS DEL SERVICIO -->
<table class="Datos-servicio table table-bordered table-striped mb-0">
  <tbody>

    <tr>
      <th scope="row">DirecciÃ³n</th>
      <td>{{ servicioSeleccionado?.servicios[0]?.direccion }}</td>
    </tr>

    <tr>
      <th scope="row">Referencia</th>
      <td>{{ servicioSeleccionado?.servicios[0]?.referencia }}</td>
    </tr>

    <tr>
      <th scope="row">Coordenadas</th>
      <td>
        <a
          [href]="'https://www.google.com/maps/search/' + servicioSeleccionado?.servicios[0]?.coordenadas"
          class="text-danger"
          target="_blank"
        >
          {{ servicioSeleccionado?.servicios[0]?.coordenadas }}
        </a>
      </td>
    </tr>

    <tr>
      <th scope="row">Fecha InstalaciÃ³n</th>
      <td>
        {{
          servicioSeleccionado?.servicios[0]?.fecha_instalacion
            | date : "EEEE dd MMMM YYYY"
        }}
      </td>
    </tr>

    <tr>
      <th scope="row">IP Equipo</th>
      <td>
        {{ servicioSeleccionado?.servicios[0]?.ip }}
        <button
          (click)="copyIp(servicioSeleccionado?.servicios[0]?.ip)"
          class="btn btn-sm btn-danger ms-2"
        >
          Copiar
        </button>
      </td>
    </tr>

    <!-- âœ… UNA SOLA FILA ONU/ONT -->
    <tr>
      <th scope="row">ONU / ONT</th>
      <td>
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
          <span class="text-monospace">{{ onuSn || "â€”" }}</span>

          @if (onuSn) {
            <div class="d-flex align-items-center gap-2">
              <span class="badge text-white" [ngClass]="ontBadgeClass">
                {{ ontEstadoTexto }}
              </span>

              <button
                type="button"
                class="btn btn-sm btn-dark"
                (click)="consultarOntConOnu()"
                [disabled]="ontEstado === 'CONECTANDO' || ontEstado === 'COOLDOWN'"
              >
                @if (ontEstado === 'CONECTANDO') { Consultando... }
                @else if (ontEstado === 'COOLDOWN') { Espera... }
                @else { Consultar ONT }
              </button>
            </div>
          }
        </div>

        @if (ontEstado === 'COOLDOWN') {
          <small class="text-warning fw-semibold d-block mt-1">
            Reintento en {{ cooldownSecOnt }}s
          </small>
        }
      </td>
    </tr>



    <tr>
      <th scope="row">TelÃ©fonos InstalaciÃ³n</th>
      <td>{{ servicioSeleccionado?.servicios[0]?.telefonos }}</td>
    </tr>

    <tr>
      <th scope="row">TÃ©cnico Instalador</th>
      <td>{{ servicioSeleccionado?.servicios[0]?.instalado_por }}</td>
    </tr>

  </tbody>
</table>



      <!-- SECCION DE SOLUCION-->
      <div
        class="opciones-resolucion d-flex flex-column border border-2 p-1 bg-dark-subtle"
      >
        <!-- SECCION DE DESCRIPCION SOLUCION-->
        <div class="solucion w-100">
          <textarea
            id="solucionInput"
            class="form-control w-100"
            rows="3"
            [(ngModel)]="detalleSolucion"
            name="solucion"
            placeholder="Describe la soluciÃ³n"
            (ngModelChange)="detalleSolucion = ($event || '').toUpperCase()"
          ></textarea>
        </div>




        <!-- SECCION DE OPCIONES SOLUCION-->
        <div class="d-flex justify-content-between w-100 h-100">
          <div
            class="opciones-radio d-flex flex-column flex-wrap justify-content-between"
          >
            <div class="form-check" style="min-width: 160px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion1"
                value="REVISION"
                (change)="asignarSolucion($event)"
                [(ngModel)]="solucionSeleccionada"
              />
              <label
                class="form-check-label"
                for="opcion1"
                style="white-space: nowrap"
              >
                EN REVISIÃ“N
              </label>
            </div>

            <div class="form-check" style="min-width: 160px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion2"
                value="RESUELTO"
                [(ngModel)]="solucionSeleccionada"
                (change)="asignarSolucion($event)"
              />
              <label
                class="form-check-label"
                for="opcion2"
                style="white-space: nowrap"
              >
                RESUELTO
              </label>
            </div>

            <div class="form-check" style="min-width: 160px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion3"
                value="VISITA"
                [(ngModel)]="solucionSeleccionada"
                (change)="asignarSolucion($event)"
              />
              <label
                class="form-check-label"
                for="opcion3"
                style="white-space: nowrap"
              >
                VISITA TÃ‰CNICA
              </label>
            </div>

            <div class="form-check" style="min-width: 160px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion4"
                value="LOS"
                [(ngModel)]="solucionSeleccionada"
                (change)="asignarSolucion($event)"
              />
              <label
                class="form-check-label"
                for="opcion4"
                style="white-space: nowrap"
              >
                VISITA TÃ‰CNICA LOS
              </label>
            </div>

            <div class="form-check" style="min-width: 200px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion5"
                value="INFRAESTRUCTURA"
                [(ngModel)]="solucionSeleccionada"
                (change)="asignarSolucion($event)"
              />
              <label
                class="form-check-label"
                for="opcion5"
                style="white-space: nowrap"
              >
                MONTAJE DE INFRAESTRUCTURA
              </label>
            </div>

            <div class="form-check" style="min-width: 160px">
              <input
                class="form-check-input"
                type="radio"
                name="reg_sop_opc"
                id="opcion6"
                value="NO CONTESTA"
                [(ngModel)]="solucionSeleccionada"
                (change)="asignarSolucion($event)"
              />
              <label
                class="form-check-label"
                for="opcion6"
                style="white-space: nowrap"
              >
                NO CONTESTA
              </label>
            </div>
          </div>

          <div class="d-flex flex-column flex-wrap justify-content-center">
            <button
              (click)="guardarSolucion()"
              class="btn btn-danger"
              [disabled]="!detalleSolucion.trim()"
            >
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- âœ… AQUÃ VA EL RESULTADO (DENTRO DE LA MISMA TABLA) -->
   @if (onuSn && showOntPanel) {
  <tr>
    <td colspan="2">

      @if (ontMensaje) {
        <div class="alert alert-light border mt-2 mb-0">
          {{ ontMensaje }}
        </div>
      }

      <!-- ðŸ‘‡ AQUÃ PEGA ESTO -->
      @if (ontResult) {
        <div class="mt-2 ont-result-card">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <div class="ont-kv"><span>SN</span><b>{{ ontResult.sn || 'â€”' }}</b></div>
              <div class="ont-kv"><span>F/S/P</span><b>{{ ontResult.fsp || 'â€”' }}</b></div>
              <div class="ont-kv"><span>ONT-ID</span><b>{{ ontResult.ontId ?? 'â€”' }}</b></div>
              <div class="ont-kv"><span>Distancia</span><b>{{ ontResult.ontLastDistanceM ?? 'â€”' }} m</b></div>
            </div>

            <div class="col-12 col-md-6">
              <div class="ont-kv"><span>Estado</span><b>{{ ontResult.runState || 'â€”' }}</b></div>
              <div class="ont-kv"><span>Causa caÃ­da</span><b>{{ ontResult.lastDownCause || 'â€”' }}</b></div>
              <div class="ont-kv"><span>Ãšltimo UP</span><b>{{ ontResult.lastUpTime || 'â€”' }}</b></div>
              <div class="ont-kv"><span>Online</span><b>{{ ontResult.onlineDuration || 'â€”' }}</b></div>
            </div>

            <div class="col-12">
              <div class="ont-kv">
                <span>DescripciÃ³n</span>
                <b>{{ ontResult.description || 'â€”' }}</b>
              </div>
            </div>
          </div>

          @if (ontResult.optical) {
            <hr class="my-2" />
            <div class="fw-bold mb-1">Potencia</div>

            @if (!ontResult.optical.available) {
              <div class="text-muted small">
                No disponible: {{ ontResult.optical.reason || 'â€”' }}
              </div>
            } @else {
              <div class="row g-2">
                <div class="col-12 col-md-4">
                  <div class="ont-kv"><span>Rx (ONT)</span><b>{{ ontResult.optical.rxDbm ?? 'â€”' }} dBm</b></div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="ont-kv"><span>Tx (ONT)</span><b>{{ ontResult.optical.txDbm ?? 'â€”' }} dBm</b></div>
                </div>
                <div class="col-12 col-md-4">
                  <div class="ont-kv"><span>OLT Rx</span><b>{{ ontResult.optical.oltRxDbm ?? 'â€”' }} dBm</b></div>
                </div>
              </div>
            }
          }
        </div>

        <!-- DEBUG (solo para verificar estructura, luego quÃ­talo) -->
        <!-- <pre class="out mt-2 mb-0">{{ ontResult | json }}</pre> -->
      }

    </td>
  </tr>
}
    <!-- BARRA HORIZONTAL DE TABS -->
    <div class="container mt-3">
      <div class="btn-group w-100" role="group" aria-label="Secciones">
        <button
          type="button"
          class="btn btn-outline-primary"
          [class.active]="activeTab === 'instalacion'"
          (click)="setTab('instalacion')"
        >
          InstalaciÃ³n
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          [class.active]="activeTab === 'soportes'"
          (click)="setTab('soportes')"
        >
          Soportes
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          [class.active]="activeTab === 'visitas'"
          (click)="setTab('visitas')"
        >
          Visitas
        </button>
      </div>
    </div>

    <!-- INSTALACIÃ“N -->
    @if (activeTab === 'instalacion') {

    <div class="imagenes-grid row">
      @for (campo of ['fachada', 'router', 'ont', 'potencia', 'speedtest',
      'cable_1', 'cable_2', 'equipo_1', 'equipo_2', 'equipo_3']; track campo) {
      @if (imagenesInstalacion[campo] && imagenesInstalacion[campo].ruta !==
      'null' && imagenesInstalacion[campo].url !== 'undefined/imagenes/null') {
      <div class="col-6 col-md-3 col-lg-2">
        <div class="card shadow-sm border rounded">
          <div class="card-body p-2 text-center">
            <div class="fw-bold text-capitalize mb-1">{{ campo }}</div>
            <img
              [src]="imagenesInstalacion[campo].url"
              alt="{{ campo }}"
              class="img-thumbnail"
              style="cursor: pointer; max-height: 150px"
              (click)="abrirImagenModal(imagenesInstalacion[campo].url)"
            />
          </div>
        </div>
      </div>
      } }
    </div>

    }

    <!-- SOPORTES -->
    @if (activeTab === 'soportes') { @if (soportesResueltos.length) { @for (s of
    soportesResueltos; track s.id) {
    <div class="mb-4 border rounded shadow-sm p-2">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <span class="badge bg-secondary">
          @switch (s?.reg_sop_opc) { @case (1) {
          <span>Sin servicio de Internet</span>
          } @case (2) {
          <span> Internet Intermitente</span>
          } @case (3) {
          <span> Cambio de contraseÃ±a</span>
          } @case (4) {
          <span> Manipulacion de equipos</span>
          } @case (5) {
          <span> Sin Definir</span>
          } }</span
        >

        <span class="badge bg-success">{{ s.reg_sop_estado }}</span>
        <span class="ms-auto small text-muted">
          {{
            s.reg_sop_fecha_acepta || s.reg_sop_fecha
              | date : "dd/MM/yyyy HH:mm"
          }}
        </span>
      </div>

      <div class="small mb-2">
        <strong>Tel:</strong>
        {{ s.reg_sop_tel || "â€”" }}
        &nbsp;Â·&nbsp;
        <strong>Registrado por:</strong>
        {{
          s.reg_sop_registrado_por_nombre || s.reg_sop_registrado_por_id || "â€”"
        }}
        &nbsp;Â·&nbsp;
        <strong>Responsable NOC:</strong>
        {{ s.reg_sop_aceptado_por_nombre || s.reg_sop_noc_id_acepta || "â€”" }}
      </div>

      @if (s.reg_sop_coment_cliente) {
      <div class="mb-1">Comentario Cliente: {{ s.reg_sop_coment_cliente }}</div>
      } SoluciÃ³n : @if (s.reg_sop_sol_det) {
      {{ s.reg_sop_sol_det }}
      }
    </div>
    } } @else {
    <div class="text-muted text-center py-2">
      Sin soportes resueltos para esta orden.
    </div>
    } }

    <!-- VISITAS -->
    @if (activeTab === 'visitas') { @for (visita of imagenesVisitas; track
    visita.id) {
    <div class="mb-4 border rounded shadow-sm p-2">
      <div class="mb-2">
        <strong class="me-1">Tipo:</strong>
        <span
          class="badge px-2 py-1"
          [ngClass]="getVisitaBadgeClass(visita.vis_tipo)"
        >
          {{ visita.vis_tipo || "â€”" }}
        </span>
        <span class="mx-1">|</span> <strong>Estado:</strong>
        {{ visita.vis_estado }} <br />
        <!-- <strong>Comentario cliente:</strong>
        {{ visita.vis_coment_cliente || "â€”" }}<br /> -->
        <strong>DiagnÃ³stico:</strong> {{ visita.vis_diagnostico || "â€”" }}
        <br />
        <strong>Detalle SoluciÃ³n:</strong> {{ visita.vis_solucion || "â€”" }}
        <br />
        <!-- <strong>Fecha resoluciÃ³n del problema:</strong>
        {{ visita.fecha_actualizacion | date : "dd/MM/yyyy HH:mm" }} -->
      </div>

      <div class="imagenes-grid row">
        @for (campo of ['img_1', 'img_2', 'img_3', 'img_4']; track campo) { @if
        (visita.imagenes[campo] && visita.imagenes[campo].ruta !== 'null' &&
        visita.imagenes[campo].url !== 'undefined/imagenes/null') {
        <div class="col-6 col-md-3 col-lg-2">
          <div class="card shadow-sm border rounded">
            <div class="card-body p-2 text-center">
              <div class="fw-bold text-uppercase mb-1">{{ campo }}</div>
              <img
                [src]="visita.imagenes[campo].url"
                alt="{{ campo }}"
                class="img-thumbnail"
                style="cursor: pointer; max-height: 150px"
                (click)="abrirImagenModal(visita.imagenes[campo].url)"
              />
            </div>
          </div>
        </div>
        } }
      </div>
    </div>
    } }
  </section>
</div>
}

<!-- Modal Imagen Ampliada (sin cambios estructurales) -->
<div
  class="modal fade"
  id="modalImagenAmpliada"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white text-center">
      <div class="modal-body p-0">
        <img
          [src]="imagenSeleccionada"
          class="img-fluid w-100 rounded"
          alt="Imagen ampliada"
        />
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button
          type="button"
          class="btn btn-outline-light"
          data-bs-dismiss="modal"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
