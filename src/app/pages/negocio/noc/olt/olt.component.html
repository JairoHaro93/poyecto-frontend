@if (isReady) {
  <main class="container mt-3">
    <div class="card">
      <div class="card-body">
        <!-- HEADER: Tabs + Estado -->
        <!-- HEADER: Tabs (estilo anterior) + Estado -->
        <div
          class="d-flex align-items-center justify-content-between gap-2 flex-wrap"
        >
          <div class="d-flex gap-2 flex-wrap">
            <button
              type="button"
              class="btn"
              [ngClass]="
                tab === 'CONECTAR'
                  ? 'btn-outline-primary'
                  : 'btn-outline-secondary'
              "
              (click)="setTab('CONECTAR')"
              [disabled]="isBusy && tab !== 'CONECTAR'"
            >
              üîå Conectar
            </button>

            <button
              type="button"
              class="btn"
              [ngClass]="tab === 'CONSULTAS' ? 'btn-dark' : 'btn-outline-dark'"
              (click)="setTab('CONSULTAS')"
              [disabled]="isBusy && tab !== 'CONSULTAS'"
            >
              üîé Consultas
            </button>

            <button
              type="button"
              class="btn"
              [ngClass]="
                tab === 'INGRESO'
                  ? 'btn-outline-success'
                  : 'btn-outline-secondary'
              "
              (click)="setTab('INGRESO')"
              [disabled]="isBusy && tab !== 'INGRESO'"
            >
              ‚ûï Ingreso de ONT
            </button>
          </div>

          <span class="badge text-white" [ngClass]="badgeClass">
            {{ estadoTexto }}
          </span>
        </div>

        <hr class="my-3" />

        <!-- =========================
             TAB: CONECTAR
        ========================== -->
        @if (tab === "CONECTAR") {
          <div class="d-flex justify-content-end mb-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="limpiarTodo()"
              [disabled]="isBusy"
            >
              üßπ Limpiar
            </button>
          </div>

          <div class="p-3 rounded border bg-light">
            <div
              class="d-flex align-items-center justify-content-between flex-wrap gap-2"
            >
              <div>
                <div class="fw-bold">Sesi√≥n OLT</div>
                <div class="text-muted small">
                  Presiona conectar para preparar la sesi√≥n (evita prompts
                  viejos).
                </div>
              </div>

              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="warmupReady()"
                [disabled]="disableConectar"
              >
                @if (estado === "READYING") {
                  <span
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Conectando...
                } @else {
                  üîå Conectar
                }
              </button>
            </div>

            @if (estado === "COOLDOWN") {
              <div class="text-warning fw-semibold mt-2">
                Reintento en {{ cooldownSec }}s
              </div>
            }

            @if (estado === "ERROR") {
              <div class="text-danger fw-semibold mt-2">
                {{ mensaje || "Error con OLT. Reintenta conexi√≥n." }}
              </div>
            }
          </div>
        }

        <!-- =========================
             TAB: CONSULTAS
        ========================== -->
        @if (tab === "CONSULTAS") {
          <div class="d-flex justify-content-end mb-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="limpiarConsultas()"
              [disabled]="isBusy"
            >
              üßπ Limpiar
            </button>
          </div>

          <form [formGroup]="oltForm" (ngSubmit)="consultarOnt()">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-7">
                <label class="form-label mb-1">Serie ONT</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="sn"
                  (input)="normalizeInput('sn')"
                  [disabled]="isBusy"
                />

                @if (checkError("sn", "required")) {
                  <small class="text-danger">Requerido</small>
                }
                @if (checkError("sn", "snInvalid")) {
                  <small class="text-danger">Formato inv√°lido..</small>
                }
              </div>

              <div class="col-12 col-md-5">
                <button
                  type="submit"
                  class="btn btn-dark w-100 btn-big"
                  [disabled]="disableConsultar"
                >
                  @if (estado === "CONECTANDO") {
                    Conectando...
                  } @else if (estado === "COOLDOWN") {
                    Espera...
                  } @else if (estado === "ELIMINANDO") {
                    Eliminando...
                  } @else if (estado === "READYING") {
                    Conectando...
                  } @else {
                    Consultar
                  }
                </button>

                @if (estado === "COOLDOWN") {
                  <small class="text-warning fw-semibold d-block mt-2">
                    Reintento en {{ cooldownSec }}s
                  </small>
                }

                @if (estado === "ERROR") {
                  <small class="text-danger fw-semibold d-block mt-2">
                    {{ mensaje || "Error con OLT. Reintenta conexi√≥n." }}
                  </small>
                }

                @if (estado === "IDLE") {
                  <small class="text-muted fw-semibold d-block mt-2">
                    Ve a ‚ÄúConectar‚Äù o presiona conectar para preparar la sesi√≥n.
                  </small>
                }
              </div>
            </div>
          </form>

          @if (result) {
            <div class="mt-3 result-card">
              <div class="row g-2">
                <div class="col-12 col-md-6">
                  <div class="kv">
                    <span>SN</span><b>{{ result.sn }}</b>
                  </div>
                  <div class="kv">
                    <span>Estado</span><b>{{ result.runState || "‚Äî" }}</b>
                  </div>
                  <div class="kv">
                    <span>F/S/P</span><b>{{ result.fsp || "‚Äî" }}</b>
                  </div>
                  <div class="kv">
                    <span>ONT-ID</span><b>{{ result.ontId ?? "‚Äî" }}</b>
                  </div>
                  <div class="kv">
                    <span>Distancia</span
                    ><b>{{ result.ontLastDistanceM ?? "‚Äî" }} metros</b>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="kv">
                    <span>Ultima ca√≠da</span
                    ><b>{{ result.lastDownCause || "‚Äî" }}</b>
                  </div>
                  <div class="kv">
                    <span>Tiempo Online</span
                    ><b class="nowrap">{{ onlineDurationUI }}</b>
                  </div>
                  <div class="kv">
                    <span>Ultima Hora Apagado</span
                    ><b>{{ lastDyingGaspTimeUI }}</b>
                  </div>
                  <div class="kv">
                    <span>Ultima Hora Caida</span><b>{{ lastDownTimeUI }}</b>
                  </div>
                  <div class="kv">
                    <span>Ultimo Acople a OLT</span><b>{{ lastUpTimeUI }}</b>
                  </div>
                </div>

                <div class="col-12">
                  <div class="kv">
                    <span>Descripci√≥n</span
                    ><b>{{ result.description || "‚Äî" }}</b>
                  </div>
                </div>
              </div>

              @if (result.optical) {
                <hr class="my-3" />
                <div class="fw-bold mb-2">Potencia</div>

                @if (!result.optical.available) {
                  <div class="text-muted small">
                    No disponible: {{ result.optical.reason || "‚Äî" }}
                  </div>
                } @else {
                  <div class="row g-2">
                    <div class="col-12 col-md-4">
                      <div class="kv">
                        <span>Rx (ONT)</span><b>{{ rxOntUI }}</b>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="kv">
                        <span>Tx (ONT)</span><b>{{ txOntUI }}</b>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="kv">
                        <span>OLT Rx</span><b>{{ oltRxUI }}</b>
                      </div>
                    </div>
                  </div>
                }
              }

              <hr class="my-3" />
              <div class="d-flex justify-content-end gap-2 flex-wrap">
                <button
                  type="button"
                  class="btn btn-danger"
                  (click)="eliminarOnt()"
                  [disabled]="disableEliminar"
                >
                  @if (estado === "ELIMINANDO") {
                    <span
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Eliminando...
                  } @else {
                    üóëÔ∏è Eliminar ONT
                  }
                </button>

                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="consultarOnt()"
                  [disabled]="disableConsultar"
                >
                  üîÑ Re-consultar
                </button>
              </div>
            </div>
          }
        }

        <!-- =========================
             TAB: INGRESO DE ONT
        ========================== -->
        @if (tab === "INGRESO") {
          <div
            class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2"
          >
            <div class="d-flex gap-2 flex-wrap">
              <button
                type="button"
                class="btn btn-outline-dark"
                (click)="buscarAutofind()"
                [disabled]="isBusy"
              >
                üîé Buscar Autofind
              </button>
            </div>

            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="limpiarIngreso()"
              [disabled]="isBusy"
            >
              üßπ Limpiar
            </button>
          </div>

          @if (autofindItems?.length) {
            <div class="p-2 border rounded mb-3 bg-white">
              <div class="fw-bold mb-2">Autofind detectadas</div>
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>F/S/P</th>
                      <th>SN</th>
                      <th>ONT-Type</th>
                      <th>Hora</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (it of autofindItems; track it.number) {
                      <tr>
                        <td>{{ it.number }}</td>
                        <td>{{ it.fsp }}</td>
                        <td class="nowrap">{{ it.snHex }}</td>
                        <td>{{ it.ontEquipmentId || "‚Äî" }}</td>
                        <td class="nowrap">{{ it.autofindTime || "‚Äî" }}</td>
                        <td class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-dark"
                            (click)="selectAutofind(it)"
                            [disabled]="isBusy"
                          >
                            Usar
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }

          <form [formGroup]="ingresoForm" (ngSubmit)="ingresarOnt()">
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Serie ONT</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="sn"
                  (input)="normalizeIngresoSn()"
                  [disabled]="isBusy"
                />
                @if (checkIngresoError("sn", "required")) {
                  <small class="text-danger">Requerido</small>
                }
                @if (checkIngresoError("sn", "snInvalid")) {
                  <small class="text-danger">Formato inv√°lido..</small>
                }
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Descripci√≥n</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="desc"
                  (input)="normalizeIngresoDesc()"
                  [disabled]="isBusy"
                  placeholder="138608_OFICINA_OPERATIVA"
                />
                @if (checkIngresoError("desc", "required")) {
                  <small class="text-danger">Requerido</small>
                }
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label mb-1">Traffic IN</label>
                <input
                  type="number"
                  class="form-control"
                  formControlName="trafficIn"
                  [disabled]="isBusy"
                />
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label mb-1">Traffic OUT</label>
                <input
                  type="number"
                  class="form-control"
                  formControlName="trafficOut"
                  [disabled]="isBusy"
                />
              </div>

              <div class="col-12 col-md-6 d-flex align-items-end">
                <button
                  type="submit"
                  class="btn btn-dark w-100 btn-big"
                  [disabled]="disableIngresar"
                >
                  @if (estado === "INGRESANDO") {
                    Ingresando...
                  } @else if (estado === "READYING") {
                    Conectando...
                  } @else if (estado === "COOLDOWN") {
                    Espera...
                  } @else {
                    Ingresar ONT
                  }
                </button>
              </div>
            </div>
          </form>

          @if (provisionResult) {
            <div class="mt-3 result-card">
              <div class="fw-bold mb-2">Resultado ingreso</div>
              <div class="row g-2">
                <div class="col-12 col-md-6">
                  <div class="kv">
                    <span>SN</span><b>{{ provisionResult.sn }}</b>
                  </div>
                  <div class="kv">
                    <span>F/S/P</span><b>{{ provisionResult.fsp }}</b>
                  </div>
                  <div class="kv">
                    <span>ONT-ID</span><b>{{ provisionResult.ontId }}</b>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="kv">
                    <span>VLAN</span><b>{{ provisionResult.vlan }}</b>
                  </div>
                  <div class="kv">
                    <span>Service-port</span
                    ><b>{{
                      provisionResult.servicePorts?.[0]?.index || "‚Äî"
                    }}</b>
                  </div>
                  <div class="kv">
                    <span>Estado SP</span
                    ><b>{{
                      provisionResult.servicePorts?.[0]?.state || "‚Äî"
                    }}</b>
                  </div>
                </div>
                <div class="col-12">
                  <div class="kv">
                    <span>Descripci√≥n</span><b>{{ provisionResult.desc }}</b>
                  </div>
                </div>
              </div>

              <hr class="my-3" />
              <div class="d-flex justify-content-end gap-2 flex-wrap">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="irAConsultasConSn(provisionResult.sn)"
                  [disabled]="isBusy"
                >
                  üîÑ Consultar esta ONT
                </button>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </main>
}
