<div class="card shadow-sm border-0 w-100">
  <div class="card-header d-flex align-items-center">
    <h6 class="mb-0">Nueva caja</h6>
    <button
      type="button"
      class="btn-close ms-auto"
      aria-label="Cerrar"
      title="Cerrar"
      (click)="close.emit()"
    ></button>
  </div>

  <div class="card-body py-1 px-2">
    <form [formGroup]="form" (ngSubmit)="submit()">
      <!-- ===== FILA 1: ciudad / tipo / segmento / S final / NOMBRE+HILO (auto) ===== -->
      <div class="row g-1 align-items-end">
        <!-- Ciudad -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Ciudad</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_ciudad"
            >
              @for (c of ciudades; track c) {
              <option [value]="c">{{ c }}</option>
              }
            </select>
          </div>
          @if (f.caja_ciudad.touched && f.caja_ciudad.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- Tipo -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Tipo</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_tipo"
            >
              <option value="PON">PON</option>
              <option value="NAP">NAP</option>
            </select>
          </div>
          @if (f.caja_tipo.touched && f.caja_tipo.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- Segmento -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Segmento</span>
            <input
              class="form-control form-control-sm"
              type="text"
              formControlName="nombre_segmento"
              placeholder="4/7/S2/1"
              style="width: 160px"
            />
          </div>
          @if (f.nombre_segmento.touched &&
          f.nombre_segmento.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- S final -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">S final</span>
            <select
              class="form-select form-select-sm"
              formControlName="s_final"
              style="width: 90px"
            >
              <option [ngValue]="null">—</option>
              @for (s of sFinalOptions; track s) {
              <option [ngValue]="s">S{{ s }}</option>
              }
            </select>
          </div>
          @if (f.s_final.touched && f.s_final.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- NOMBRE + HILO ocupan el resto -->
        <div class="col min-w-0">
          <div class="row g-1">
            <div class="col-xxl-7 col-lg-6 col-12">
              <input
                class="form-control form-control-sm text-end w-100"
                type="text"
                formControlName="caja_nombre"
                [attr.title]="f.caja_nombre.value || ''"
                readonly
              />
            </div>
            <div class="col-xxl-5 col-lg-6 col-12">
              <input
                class="form-control form-control-sm text-start w-100"
                type="text"
                formControlName="caja_hilo"
                [attr.title]="f.caja_hilo.value || ''"
                readonly
              />
            </div>
          </div>
        </div>
      </div>

      <!-- ===== FILA 2: estado / fibra / hilo / coordenadas / guardar ===== -->
      <div class="row g-1 align-items-end mt-1">
        <!-- Estado -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Estado</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_estado"
            >
              <option value="DISEÑO">DISEÑO</option>
              <option value="ACTIVO">ACTIVO</option>
            </select>
          </div>
        </div>

        <!-- Fibra -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Fibra</span>
            <select
              class="form-select form-select-sm"
              formControlName="fibra_tipo"
            >
              <option value="DROP">DROP</option>
              <option value="FLAT">FLAT</option>
              <option value="ADSS">ADSS</option>
              <option value="MINIADSS">MINIADSS</option>
            </select>
          </div>
        </div>

        <!-- Hilo / Desconocido / Buffer/Hilo -->
        <div class="col-auto d-flex align-items-end gap-1 flex-wrap">
          <div class="form-check form-check-inline mb-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="chkUnknown"
              formControlName="hilo_desconocido"
            />
            <label class="form-check-label small" for="chkUnknown"
              >DESCONOCIDO</label
            >
          </div>

          <!-- Hilo simple (DROP/FLAT) -->
          @if (isFibraSimple()) {
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Hilo</span>
            <select
              class="form-select form-select-sm"
              formControlName="simple_hilo"
              [disabled]="hiloDesconocido"
            >
              @for (h of simpleHilos; track h) {
              <option [ngValue]="h">{{ h }}</option>
              }
            </select>
          </div>
          @if (!hiloDesconocido && f.simple_hilo.touched &&
          f.simple_hilo.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          } } @else {
          <!-- Buffer / Hilo (ADSS/MINIADSS) -->
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Buf</span>
            <select
              class="form-select form-select-sm"
              formControlName="buffer"
              [disabled]="hiloDesconocido"
            >
              @for (b of buffers; track b) {
              <option [ngValue]="b">{{ b }}</option>
              }
            </select>
            <span class="input-group-text">/</span>
            <span class="input-group-text">H</span>
            <select
              class="form-select form-select-sm"
              formControlName="hilo_num"
              [disabled]="hiloDesconocido"
            >
              @for (h of hilos; track h) {
              <option [ngValue]="h">{{ h }}</option>
              }
            </select>
          </div>
          @if ( !hiloDesconocido && ((f.buffer.touched &&
          f.buffer.hasError('required')) || (f.hilo_num.touched &&
          f.hilo_num.hasError('required'))) ) {
          <div class="form-text text-danger">Ambos requeridos</div>
          } }
        </div>

        <!-- Coordenadas + Seleccionar en mapa -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Lat,Lng</span>
            <input
              class="form-control form-control-sm"
              type="text"
              formControlName="caja_coordenadas"
              placeholder="-0.934521,-78.615834"
              style="width: 180px"
            />
            <button
              class="btn btn-outline-danger btn-sm pick-btn"
              type="button"
              (click)="requestPick.emit()"
              title="Seleccionar en mapa"
            >
              Seleccionar
            </button>
          </div>
          @if (f.caja_coordenadas.touched && f.caja_coordenadas.errors) {
          <div class="form-text text-danger">
            {{ f.caja_coordenadas.errors["coords"] }}
          </div>
          }
        </div>

        <!-- Guardar -->
        <div class="col-auto ms-auto">
          <button
            class="btn btn-danger btn-sm px-3"
            type="submit"
            [disabled]="isSaving || form.invalid"
          >
            {{ isSaving ? "Guardando…" : "Guardar" }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
