<div class="card shadow-sm border-0 w-100">
  <div class="card-header d-flex align-items-center">
    <h6 class="mb-0">Nueva caja</h6>
    <button
      type="button"
      class="btn-close ms-auto"
      aria-label="Cerrar"
      title="Cerrar"
      (click)="close.emit()"
    ></button>
  </div>

  <div class="card-body py-1 px-2">
    <!-- ===== FILA 1: ciudad/tipo/slot/pon/nap + resumen derecha ===== -->
    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="row g-1 align-items-end">
        <!-- Ciudad -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Ciudad</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_ciudad"
            >
              @for (c of ciudades; track c) {
              <option [value]="c">{{ c }}</option>
              }
            </select>
          </div>
          @if (f.caja_ciudad.touched && f.caja_ciudad.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- Tipo -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Tipo</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_tipo"
            >
              <option value="PON">PON</option>
              <option value="NAP">NAP</option>
            </select>
          </div>
        </div>

        <!-- Slot -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Slot</span>
            <select class="form-select form-select-sm" formControlName="slot">
              @for (s of slots; track s) {
              <option [ngValue]="s">{{ s }}</option>
              }
            </select>
          </div>
          @if (f.slot.touched && f.slot.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- PON -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">PON</span>
            <select class="form-select form-select-sm" formControlName="pon">
              @for (p of pones; track p) {
              <option [ngValue]="p">{{ p }}</option>
              }
            </select>
          </div>
          @if (f.pon.touched && f.pon.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>

        <!-- NAP (solo si aplica) -->
        @if (isTipoNAP()) {
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Salida</span>
            <select class="form-select form-select-sm" formControlName="nap">
              @for (n of salidasNap; track n) {
              <option [ngValue]="n">{{ n }}</option>
              }
            </select>
          </div>
          @if (f.nap.touched && f.nap.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          }
        </div>
        }

        <!-- Resumen a la derecha -->
        <div
          class="col ms-auto d-flex align-items-center justify-content-end gap-2"
        >
          <small class="text-muted d-none d-xl-inline">Resumen:</small>
          <span class="badge bg-light text-dark border fw-normal">
            <span class="text-muted">Caja:</span>
            <strong class="ms-1">{{ f.caja_nombre.value || "—" }}</strong>
          </span>
          <span class="badge bg-light text-dark border fw-normal">
            <span class="text-muted">Hilo:</span>
            <strong class="ms-1">{{ f.caja_hilo.value || "—" }}</strong>
          </span>
        </div>
      </div>

      <!-- ===== FILA 2: estado/fibra/hilo/coords/guardar ===== -->
      <div class="row g-1 align-items-end mt-1">
        <!-- Estado -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Estado</span>
            <select
              class="form-select form-select-sm"
              formControlName="caja_estado"
            >
              <option value="DISEÑO">DISEÑO</option>
              <option value="ACTIVO">ACTIVO</option>
            </select>
          </div>
        </div>

        <!-- Fibra -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Fibra</span>
            <select
              class="form-select form-select-sm"
              formControlName="fibra_tipo"
            >
              <option value="DROP">DROP</option>
              <option value="FLAT">FLAT</option>
              <option value="ADSS">ADSS</option>
              <option value="MINIADSS">MINIADSS</option>
            </select>
          </div>
        </div>

        <!-- Hilo / Unknown / Buffer/Hilo -->
        <div class="col-auto d-flex align-items-end gap-1 flex-wrap">
          <div class="form-check form-check-inline mb-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="chkUnknown"
              formControlName="hilo_desconocido"
            />
            <label class="form-check-label small" for="chkUnknown"
              >DESCONOCIDO</label
            >
          </div>

          <!-- Hilo simple (DROP/FLAT) -->
          @if (isFibraSimple()) {
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Hilo</span>
            <select
              class="form-select form-select-sm"
              formControlName="simple_hilo"
              [disabled]="hiloDesconocido"
            >
              @for (h of simpleHilos; track h) {
              <option [ngValue]="h">{{ h }}</option>
              }
            </select>
          </div>
          @if (!hiloDesconocido && f.simple_hilo.touched &&
          f.simple_hilo.hasError('required')) {
          <div class="form-text text-danger">Requerido</div>
          } } @else {
          <!-- Buffer / Hilo (ADSS/MINIADSS) -->
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Buf</span>
            <select
              class="form-select form-select-sm"
              formControlName="buffer"
              [disabled]="hiloDesconocido"
            >
              @for (b of buffers; track b) {
              <option [ngValue]="b">{{ b }}</option>
              }
            </select>
            <span class="input-group-text">/</span>
            <span class="input-group-text">H</span>
            <select
              class="form-select form-select-sm"
              formControlName="hilo_num"
              [disabled]="hiloDesconocido"
            >
              @for (h of hilos; track h) {
              <option [ngValue]="h">{{ h }}</option>
              }
            </select>
          </div>
          @if (!hiloDesconocido && ((f.buffer.touched &&
          f.buffer.hasError('required')) || (f.hilo_num.touched &&
          f.hilo_num.hasError('required')))) {
          <div class="form-text text-danger">Ambos requeridos</div>
          } }
        </div>

        <!-- Coordenadas + Seleccionar en mapa -->
        <div class="col-auto">
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Lat,Lng</span>
            <input
              class="form-control form-control-sm"
              type="text"
              formControlName="caja_coordenadas"
              style="width: 180px"
            />
            <button
              class="btn btn-outline-danger btn-sm pick-btn"
              type="button"
              (click)="requestPick.emit()"
            >
              Seleccionar
            </button>
          </div>
          @if (f.caja_coordenadas.touched && f.caja_coordenadas.errors) {
          <div class="form-text text-danger">
            {{ f.caja_coordenadas.errors["coords"] }}
          </div>
          }
        </div>

        <!-- Guardar -->
        <div class="col-auto ms-auto">
          <button
            class="btn btn-danger btn-sm px-3"
            type="submit"
            [disabled]="isSaving || form.invalid"
          >
            {{ isSaving ? "Guardando…" : "Guardar" }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
