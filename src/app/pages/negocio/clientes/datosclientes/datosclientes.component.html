<!-- Overlay local del componente -->
@if (isReady) {
<div class="fade-in">
  <main>
    <!-- Datos generales -->
    <section
      class="container m-3 border border-1 border-black p-2 datos_generales shadow"
    >
      <h4>DATOS GENERALES</h4>

      <!-- Campo de búsqueda por nombre (server-side, mínimo 2 letras) -->
      <div class="mb-3 d-flex gap-2 align-items-center">
        <label for="cliente-input" style="min-width: 100px">Nombre</label>

        <!-- Wrapper: alinea la lista justo debajo del input -->
        <div class="sugerencias-wrap">
          <input
            id="cliente-input"
            type="text"
            class="form-control"
            [formControl]="queryCtrl"
            (keydown)="onNombreKeydown($event)"
            (blur)="onNombreBlur()"
            (focus)="onNombreFocus()"
            placeholder="Ingrese el nombre del cliente"
            style="width: 100%; max-width: 500px"
            autocomplete="off"
            [attr.aria-autocomplete]="'list'"
            [attr.aria-expanded]="
              showSugerencias && sugerencias.length > 0 ? 'true' : 'false'
            "
            [attr.aria-controls]="'lista-sug-clientes'"
          />

          <!-- Lista de sugerencias -->
          <div
            *ngIf="showSugerencias && sugerencias.length > 0"
            id="lista-sug-clientes"
            class="sugerencias"
            role="listbox"
          >
            <div
              *ngFor="let c of sugerencias; let i = index"
              role="option"
              [attr.aria-selected]="i === highlightedIndex"
              class="sugerencia-item"
              [class.active]="i === highlightedIndex"
              (mouseenter)="highlightedIndex = i"
              (mousedown)="seleccionarSugerencia(c)"
            >
              {{ c.nombre_completo }}
            </div>
          </div>
        </div>
      </div>

      <!-- Campo de búsqueda por cédula (directo) -->
      <div class="mb-3 d-flex gap-2 align-items-center">
        <label for="cliente-cedula-input" style="min-width: 100px"
          >Cédula</label
        >
        <input
          id="cliente-cedula-input"
          type="text"
          class="form-control"
          [(ngModel)]="busquedaCedula"
          (change)="buscarClientePorCedula()"
          (keyup.enter)="buscarClientePorCedula()"
          placeholder="Ingrese la cédula del cliente"
          style="width: 100%; max-width: 500px"
        />
      </div>
    </section>

    <!-- Mostrar la información de los servicios del cliente seleccionado -->
    <section
      class="container"
      *ngIf="clienteSeleccionado && clienteSeleccionado.servicios?.length"
    >
      <table border="2" class="table tabla-servicios">
        <thead>
          <tr class="custom-header">
            <th></th>
            <th>Orden</th>
            <th>Dirección</th>
            <th>Referencia</th>
            <th>Plan Contratado</th>
            <th>Precio</th>
            <th>Pago</th>
            <th>Cortado</th>
            <th>Servicio</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let servicio of clienteSeleccionado.servicios"
            [ngClass]="{ 'selected-row': servicio === servicioSeleccionado }"
          >
            <td class="align-items-center text-center">
              <input
                type="radio"
                name="servicioSeleccionado"
                [value]="servicio"
                [(ngModel)]="servicioSeleccionado"
                (change)="onServicioSeleccionado()"
              />
            </td>
            <td class="text-nowrap">{{ servicio.orden_instalacion }}</td>
            <td>{{ servicio.direccion }}</td>
            <td>{{ servicio.referencia }}</td>
            <td class="text-nowrap">{{ servicio.plan_nombre }}</td>
            <td class="text-nowrap">{{ servicio.precio }}</td>
            <td class="text-nowrap">{{ servicio.estado }}</td>
            <td class="text-nowrap">{{ servicio.cortado }}</td>
            <td class="text-nowrap">{{ servicio.servicio }}</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Mostrar información del servicio seleccionado -->
    <section class="container mt-3 shadow" *ngIf="servicioSeleccionado">
      <table class="table tabla-informacion">
        <tbody>
          <tr>
            <td>Modalidad</td>
            <td>
              {{ servicioSeleccionado.tipo }}
            </td>
          </tr>

          <tr>
            <td>Tipo de instalacion</td>
            <td>
              {{ servicioSeleccionado.tipo_instalacion }}
            </td>
          </tr>
          <tr>
            <td>Estado de la instalacion</td>
            <td>
              {{ servicioSeleccionado.estado_instalacion }}
            </td>
          </tr>
          <tr>
            <td>Coordenadas</td>
            <td>
              <a
                [href]="
                  'https://www.google.com/maps/search/' +
                  servicioSeleccionado.coordenadas
                "
                style="color: red"
                target="_blank"
              >
                {{ servicioSeleccionado.coordenadas }}
              </a>
            </td>
          </tr>
          <tr>
            <td>IP</td>
            <td>
              <a
                [href]="formatIpUrl(servicioSeleccionado.ip)"
                style="color: red"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ servicioSeleccionado.ip }}
              </a>
            </td>
          </tr>
          <tr>
            <td>Fecha Instalación</td>
            <td>
              {{
                servicioSeleccionado.fecha_instalacion
                  | date : "EEEE dd MMMM YYYY "
              }}
            </td>
          </tr>
          <tr>
            <td>Tecnico Instalador</td>
            <td>
              {{ servicioSeleccionado.instalado_por }}
            </td>
          </tr>
          <tr>
            <td>Telefonos</td>
            <td>
              {{ servicioSeleccionado.telefonos }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- DIV INSTALACION-->
      <div>
        <h1 class="titulo-seccion">Instalación</h1>
      </div>

      <div class="imagenes-grid row">
        @for (campo of ['fachada', 'router', 'ont', 'potencia', 'speedtest',
        'cable_1', 'cable_2', 'equipo_1', 'equipo_2', 'equipo_3']; track campo)
        { @if ( imagenesInstalacion[campo] && imagenesInstalacion[campo].ruta
        !== 'null' && imagenesInstalacion[campo].url !==
        'undefined/imagenes/null' ) {
        <div class="col-6 col-md-3 col-lg-2">
          <div class="card shadow-sm border rounded">
            <div class="card-body p-2 text-center">
              <div class="fw-bold text-capitalize mb-1">{{ campo }}</div>
              <img
                [src]="imagenesInstalacion[campo].url"
                alt="{{ campo }}"
                class="img-thumbnail"
                style="cursor: pointer; max-height: 150px"
                (click)="abrirImagenModal(imagenesInstalacion[campo].url)"
              />
            </div>
          </div>
        </div>
        } }
      </div>

      <!-- DIV VISITAS -->
      <div class="mt-4">
        <h1 class="titulo-seccion">Visitas</h1>
      </div>

      @for (visita of imagenesVisitas; track visita.id) {
      <div class="mb-4 border rounded shadow-sm p-2">
        <div class="mb-2">
          <!-- <strong>ID Visita:</strong> {{ visita.id }} <br /> -->

          <strong>Tipo:</strong> {{ visita.vis_tipo }} |
          <strong>Estado:</strong> {{ visita.vis_estado }} <br />
          <strong>Comentario cliente:</strong> {{ visita.vis_coment_cliente
          }}<br />
          <strong>Diagnóstico:</strong> {{ visita.vis_diagnostico }} <br />
          <strong>Detalle Solución:</strong> {{ visita.vis_solucion }} <br />
          <strong>Fecha resolución del problema:</strong>
          {{ visita.fecha_actualizacion | date : "dd/MM/yyyy HH:mm" }}
        </div>

        <div class="imagenes-grid row">
          @for (campo of ['img_1', 'img_2', 'img_3', 'img_4']; track campo) {
          @if (visita.imagenes[campo] && visita.imagenes[campo].ruta !== 'null'
          && visita.imagenes[campo].url !== 'undefined/imagenes/null') {
          <div class="col-6 col-md-3 col-lg-2">
            <div class="card shadow-sm border rounded">
              <div class="card-body p-2 text-center">
                <div class="fw-bold text-uppercase mb-1">{{ campo }}</div>
                <img
                  [src]="visita.imagenes[campo].url"
                  alt="{{ campo }}"
                  class="img-thumbnail"
                  style="cursor: pointer; max-height: 150px"
                  (click)="abrirImagenModal(visita.imagenes[campo].url)"
                />
              </div>
            </div>
          </div>
          } }
        </div>
      </div>
      }
    </section>
  </main>
</div>
}

<!-- Modal Imagen Ampliada -->
<div
  class="modal fade"
  id="modalImagenAmpliada"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white text-center">
      <div class="modal-body p-0">
        <img
          [src]="imagenSeleccionada"
          class="img-fluid w-100 rounded"
          alt="Imagen ampliada"
        />
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button
          type="button"
          class="btn btn-outline-light"
          data-bs-dismiss="modal"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
